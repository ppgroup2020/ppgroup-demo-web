<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PP Group — Dashboard Cliente</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <img src="/assets/logo-pp-original.png" alt="PP Group" />
    </div>
    <div class="actions">
      <button id="btnLogout">Sair</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button data-tab="ag">Agendamentos</button>
      <button data-tab="or">Orçamentos</button>
      <button data-tab="ck">Check-ups</button>
    </div>

    <div id="tab-ag" class="tab active">
      <div class="card">
        <h2 class="title">Os meus Agendamentos <span id="count_ag" class="pill">0</span></h2>
        <div id="list_ag" class="list"></div>
      </div>
    </div>

    <div id="tab-or" class="tab">
      <div class="card">
        <h2 class="title">Os meus Orçamentos <span id="count_or" class="pill">0</span></h2>
        <div id="list_or" class="list"></div>
      </div>
    </div>

    <div id="tab-ck" class="tab">
      <div class="card">
        <h2 class="title">Os meus Check-ups <span id="count_ck" class="pill">0</span></h2>
        <div id="list_ck" class="list"></div>
      </div>
      <div class="card">
        <h3 class="title">Fotos do Check-up selecionado</h3>
        <div id="gal_ck" class="gallery"></div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('ppgroup_token');
    const user = JSON.parse(localStorage.getItem('ppgroup_user') || 'null');
    const API_BASE = (window.PP_API_BASE) ? window.PP_API_BASE : ((location.origin.includes('localhost') ? 'http://localhost:3000' : location.origin) + '/api');

    if(!token || !user){ location.href = './index.html'; }

    document.getElementById('btnLogout').addEventListener('click', ()=>{
      localStorage.removeItem('ppgroup_token');
      localStorage.removeItem('ppgroup_user');
      location.href = './index.html';
    });

    const tabs = document.querySelectorAll('.tabs button');
    const panes = { ag: document.getElementById('tab-ag'), or: document.getElementById('tab-or'), ck: document.getElementById('tab-ck') };
    function setActiveTab(key){
      tabs.forEach(x => x.classList.toggle('active', x.dataset.tab===key));
      Object.values(panes).forEach(p => p.classList.remove('active'));
      panes[key].classList.add('active');
    }
    tabs.forEach(b => b.addEventListener('click', ()=> setActiveTab(b.dataset.tab)));
    tabs[0].classList.add('active');

    function showLoading(targetId, text){
      const el = document.getElementById(targetId);
      el.innerHTML = `<div class="muted"><span class="spinner"></span>${text||'A carregar...'}</div>`;
    }
    function estadoChip(v){ if(!v) return ''; return `<span class="pill">${v}</span>`; }
    function formatDate(d,h){ try{ return new Intl.DateTimeFormat('pt-PT',{dateStyle:'medium'}).format(new Date(d)) + (h?` • ${h}`:''); }catch{return `${d||'-'} ${h||''}`;} }

    async function loadAg(){
      showLoading('list_ag','A carregar agendamentos...');
      const res = await fetch(API_BASE + '/appointments', { headers: { 'Authorization': 'Bearer ' + token } });
      const data = res.ok ? await res.json() : [];
      document.getElementById('count_ag').textContent = data.length;
      const list = document.getElementById('list_ag');
      if(!data.length){ list.innerHTML = '<div class="muted">Sem agendamentos de momento.</div>'; return; }
      list.innerHTML = data.map(a => `
        <div class="row">
          <div><strong>${a.servico || 'Serviço'}</strong> ${estadoChip(a.estado)}</div>
          <div class="muted">${formatDate(a.data,a.hora)}</div>
          ${a.notas ? `<div class="muted">Notas: ${a.notas}</div>` : ''}
        </div>
      `).join('');
    }
    async function loadOr(){
      showLoading('list_or','A carregar orçamentos...');
      const res = await fetch(API_BASE + '/quotes', { headers: { 'Authorization': 'Bearer ' + token } });
      const data = res.ok ? await res.json() : [];
      document.getElementById('count_or').textContent = data.length;
      const list = document.getElementById('list_or');
      if(!data.length){ list.innerHTML = '<div class="muted">Sem orçamentos.</div>'; return; }
      list.innerHTML = data.map(q => `
        <div class="row">
          <div><strong>${q.item || 'Orçamento'}</strong> ${estadoChip(q.estado)}</div>
          <div class="muted">${q.descricao || ''}</div>
          <div class="muted">Valor estimado: ${q.valor_est || '-'}</div>
        </div>
      `).join('');
    }
    async function loadCk(){
      showLoading('list_ck','A carregar check-ups...');
      const res = await fetch(API_BASE + '/checkups', { headers: { 'Authorization': 'Bearer ' + token } });
      const data = res.ok ? await res.json() : [];
      document.getElementById('count_ck').textContent = data.length;
      const list = document.getElementById('list_ck');
      const gal = document.getElementById('gal_ck');
      gal.innerHTML = '';
      if(!data.length){ list.innerHTML = '<div class="muted">Sem check-ups.</div>'; return; }
      list.innerHTML = data.map(c => `
        <div class="row check-item" data-id="${c.id}">
          <div><strong>Check-up #${c.id}</strong></div>
          <div class="muted">${c.data_check || ''} • ${c.estado_veiculo || ''}</div>
          ${c.observacoes ? `<div class="muted">Obs: ${c.observacoes}</div>` : ''}
        </div>
      `).join('');
      document.querySelectorAll('.check-item').forEach(it => it.addEventListener('click', ()=> loadCkPhotos(it.dataset.id)));
    }
    async function loadCkPhotos(id){
      const res = await fetch(API_BASE + `/checkups/${id}/photos`, { headers: { 'Authorization': 'Bearer ' + token } });
      const data = res.ok ? await res.json() : [];
      const gal = document.getElementById('gal_ck');
      if(!data.length){ gal.innerHTML = '<div class="muted">Sem fotos para este check-up.</div>'; return; }
      gal.innerHTML = data.map(p => `<a href="${p.url}" target="_blank"><img src="${p.url}" alt="${p.filename}" /></a>`).join('');
    }
    loadAg(); loadOr(); loadCk();
  </script>
</body>
</html>
